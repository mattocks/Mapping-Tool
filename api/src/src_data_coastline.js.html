<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"> <style>
	.KEYW {color: #933;}
	.COMM {color: #bbb; font-style: italic;}
	.NUMB {color: #393;}
	.STRN {color: #393;}
	.REGX {color: #339;}
	.linenumber {border-right: 1px dotted #666; color: #666; font-style: normal;}
	</style></head><body><pre><span class='linenumber'>  1</span> <span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">Coastline</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>  2</span> 	</span><span class="COMM">/**
<span class='linenumber'>  3</span> 	 * 
<span class='linenumber'>  4</span> 	 */</span><span class="WHIT">
<span class='linenumber'>  5</span> 	</span><span class="NAME">initialize</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>  6</span> 		</span><span class="COMM">// Cartagen.observe('predraw',		'draw',this)</span><span class="WHIT">
<span class='linenumber'>  7</span> 		</span><span class="COMM">// Cartagen.observe('postdraw',		'cleanup',this)</span><span class="WHIT">
<span class='linenumber'>  8</span> 		</span><span class="COMM">// Cartagen.observe('initialize',	'setup',this)</span><span class="WHIT">
<span class='linenumber'>  9</span> 
<span class='linenumber'> 10</span> 		</span><span class="COMM">// Cartagen.observe({</span><span class="WHIT">
<span class='linenumber'> 11</span> 		</span><span class="COMM">// 	predraw: 'a',</span><span class="WHIT">
<span class='linenumber'> 12</span> 		</span><span class="COMM">// 	draw: 'b',</span><span class="WHIT">
<span class='linenumber'> 13</span> 		</span><span class="COMM">// 	postdraw: 'c'</span><span class="WHIT">
<span class='linenumber'> 14</span> 		</span><span class="COMM">// }, this)</span><span class="WHIT">
<span class='linenumber'> 15</span> 		
<span class='linenumber'> 16</span> 		</span><span class="NAME">Glop.observe</span><span class="PUNC">(</span><span class="STRN">'cartagen:predraw'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">Coastline.draw.bindAsEventListener</span><span class="PUNC">(</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'> 17</span> 	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='linenumber'> 18</span> 	</span><span class="COMM">/**
<span class='linenumber'> 19</span> 	 * Array of coastline ways to be assembled occasionally into coastline 'collected way' relations
<span class='linenumber'> 20</span> 	 */</span><span class="WHIT">
<span class='linenumber'> 21</span> 	</span><span class="NAME">coastlines</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT">
<span class='linenumber'> 22</span> 	</span><span class="COMM">/**
<span class='linenumber'> 23</span> 	 * Array of nodes of coastlines within the viewport, combining multiple 
<span class='linenumber'> 24</span> 	 * coastlines and the viewport corners where applicable; used to 
<span class='linenumber'> 25</span> 	 * 'walk' around the viewport. Solves peninsula/estuary problem where 
<span class='linenumber'> 26</span> 	 * multiple unconnected coastlines enter the viewport and must be reconciled
<span class='linenumber'> 27</span> 	 */</span><span class="WHIT">
<span class='linenumber'> 28</span> 	</span><span class="NAME">coastline_nodes</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT">
<span class='linenumber'> 29</span> 	</span><span class="COMM">/**
<span class='linenumber'> 30</span> 	 * 
<span class='linenumber'> 31</span> 	 */</span><span class="WHIT">
<span class='linenumber'> 32</span> 	</span><span class="NAME">assembled_coastline</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT">
<span class='linenumber'> 33</span> 	</span><span class="COMM">/**
<span class='linenumber'> 34</span> 	 * 
<span class='linenumber'> 35</span> 	 */</span><span class="WHIT">
<span class='linenumber'> 36</span> 	</span><span class="NAME">draw</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'> 37</span> 		</span><span class="NAME">Coastline.assembled_coastline</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="WHIT">
<span class='linenumber'> 38</span> 		</span><span class="NAME">Feature.relations.values</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">object</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'> 39</span> 			</span><span class="COMM">// invent a better way to trigger collect_nodes, based on Viewport change:</span><span class="WHIT">
<span class='linenumber'> 40</span> 			</span><span class="COMM">// if (Glop.frame == 0 || Glop.frame % 30 == 0) object.collect_nodes()</span><span class="WHIT">
<span class='linenumber'> 41</span> 			</span><span class="NAME">$l</span><span class="PUNC">(</span><span class="NAME">object.id</span><span class="PUNC">+</span><span class="STRN">' relation'</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'> 42</span> 			</span><span class="NAME">object.collect_nodes</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'> 43</span> 			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">object.coastline_nodes.length</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">Coastline.assembled_coastline.push</span><span class="PUNC">(</span><span class="PUNC">[</span><span class="NAME">object.coastline_nodes</span><span class="PUNC">,</span><span class="PUNC">[</span><span class="NAME">object.entry_angle</span><span class="PUNC">,</span><span class="NAME">object.exit_angle</span><span class="PUNC">]</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'> 44</span> 		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'> 45</span> 	
<span class='linenumber'> 46</span> 		</span><span class="COMM">// if we have any coastline relations to run through and draw:</span><span class="WHIT">
<span class='linenumber'> 47</span> 		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">Coastline.assembled_coastline.length</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'> 48</span> 			</span><span class="NAME">Coastline.assembled_coastline.sort</span><span class="PUNC">(</span><span class="NAME">Coastline.sort_coastlines_by_angle</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'> 49</span> 
<span class='linenumber'> 50</span> 			</span><span class="NAME">$C.begin_path</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'> 51</span> 		
<span class='linenumber'> 52</span> 			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">start_corner</span><span class="PUNC">,</span><span class="NAME">end_corner</span><span class="PUNC">,</span><span class="NAME">start_angle</span><span class="PUNC">,</span><span class="NAME">end_angle</span><span class="WHIT">
<span class='linenumber'> 53</span> 			</span><span class="NAME">Coastline.assembled_coastline.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">coastline</span><span class="PUNC">,</span><span class="NAME">index</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'> 54</span> 				</span><span class="NAME">coastline.push</span><span class="PUNC">(</span><span class="NAME">Viewport.nearest_corner</span><span class="PUNC">(</span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'> 55</span> 				</span><span class="NAME">coastline.push</span><span class="PUNC">(</span><span class="NAME">Viewport.nearest_corner</span><span class="PUNC">(</span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'> 56</span> 			</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'> 57</span> 		
<span class='linenumber'> 58</span> 			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">corners</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="WHIT">
<span class='linenumber'> 59</span> 		
<span class='linenumber'> 60</span> 			</span><span class="NAME">Coastline.assembled_coastline.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">coastline</span><span class="PUNC">,</span><span class="NAME">index</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> 
<span class='linenumber'> 61</span> 				</span><span class="COMM">//coastline[2] = child start_corner ([x,y])</span><span class="WHIT">
<span class='linenumber'> 62</span> 				</span><span class="COMM">//coastline[3] = child end_corner ([x,y])</span><span class="WHIT">
<span class='linenumber'> 63</span> 				</span><span class="NAME">corners.push</span><span class="PUNC">(</span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'> 64</span> 				</span><span class="NAME">$C.move_to</span><span class="PUNC">(</span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'> 65</span> 			
<span class='linenumber'> 66</span> 				</span><span class="COMM">// $l(coastline[0].length+':'+coastline[2][2]+'=start '+coastline[0].first()[0]+','+coastline[0].first()[1]+'=first')</span><span class="WHIT">
<span class='linenumber'> 67</span> 			
<span class='linenumber'> 68</span> 				</span><span class="COMM">// $C.save()</span><span class="WHIT">
<span class='linenumber'> 69</span> 				</span><span class="COMM">// $C.opacity(0.4)</span><span class="WHIT">
<span class='linenumber'> 70</span> 				</span><span class="COMM">// $C.fill_style('green')</span><span class="WHIT">
<span class='linenumber'> 71</span> 				</span><span class="COMM">// $C.rect(coastline[2][0]-50,coastline[2][1]-50,100,100)</span><span class="WHIT">
<span class='linenumber'> 72</span> 				</span><span class="COMM">// $C.restore()</span><span class="WHIT">
<span class='linenumber'> 73</span> 			
<span class='linenumber'> 74</span> 				</span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">,</span><span class="NAME">c_index</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> 
<span class='linenumber'> 75</span> 					</span><span class="NAME">$C.line_to</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="NAME">node</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'> 76</span> 					</span><span class="COMM">// $C.save()</span><span class="WHIT">
<span class='linenumber'> 77</span> 					</span><span class="COMM">// $C.fill_style('green')</span><span class="WHIT">
<span class='linenumber'> 78</span> 					</span><span class="COMM">// $C.rect(node[0]-5,node[1]-5,10,10)</span><span class="WHIT">
<span class='linenumber'> 79</span> 					</span><span class="COMM">// $C.draw_text("Helvetica",20,'white',node[0]-10,node[1]-10,parseInt((coastline[1][0]*180)/Math.PI)+','+index+':'+c_index)</span><span class="WHIT">
<span class='linenumber'> 80</span> 					</span><span class="COMM">// $C.save()</span><span class="WHIT">
<span class='linenumber'> 81</span> 				</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT"> 
<span class='linenumber'> 82</span> 				</span><span class="NAME">$C.line_to</span><span class="PUNC">(</span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">3</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">3</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'> 83</span> 			
<span class='linenumber'> 84</span> 				</span><span class="COMM">// if there are remaining coastlines, clockwise of this one:</span><span class="WHIT">
<span class='linenumber'> 85</span> 				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">Coastline.assembled_coastline</span><span class="PUNC">[</span><span class="NAME">index</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'> 86</span> 					</span><span class="COMM">// walk back to the start point before going on to the next:</span><span class="WHIT">
<span class='linenumber'> 87</span> 					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">index</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">Coastline.assembled_coastline.length</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'> 88</span> 						</span><span class="NAME">corners.push</span><span class="PUNC">(</span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">3</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'> 89</span> 						</span><span class="NAME">$l</span><span class="PUNC">(</span><span class="STRN">'walking to beginning!: '</span><span class="PUNC">+</span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">3</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">+</span><span class="STRN">"/"</span><span class="PUNC">+</span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">+</span><span class="STRN">':'</span><span class="PUNC">+</span><span class="NAME">Coastline.walk</span><span class="PUNC">(</span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">3</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="KEYW">false</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">inspect</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'> 90</span> 						</span><span class="NAME">Coastline.walk</span><span class="PUNC">(</span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">3</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="KEYW">false</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">n</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'> 91</span> 							</span><span class="NAME">$C.line_to</span><span class="PUNC">(</span><span class="NAME">n</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="NAME">n</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'> 92</span> 						</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'> 93</span> 					</span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'> 94</span> 					</span><span class="COMM">// walk on to the next coastline:</span><span class="WHIT">
<span class='linenumber'> 95</span> 					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">Coastline.assembled_coastline</span><span class="PUNC">[</span><span class="NAME">index</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'> 96</span> 						</span><span class="NAME">corners.push</span><span class="PUNC">(</span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="NAME">Coastline.assembled_coastline</span><span class="PUNC">[</span><span class="NAME">index</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'> 97</span> 						</span><span class="NAME">$l</span><span class="PUNC">(</span><span class="STRN">'walking to next!: '</span><span class="PUNC">+</span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">+</span><span class="STRN">"/"</span><span class="PUNC">+</span><span class="NAME">Coastline.assembled_coastline</span><span class="PUNC">[</span><span class="NAME">index</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">+</span><span class="STRN">':'</span><span class="PUNC">+</span><span class="NAME">Coastline.walk</span><span class="PUNC">(</span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="NAME">Coastline.assembled_coastline</span><span class="PUNC">[</span><span class="NAME">index</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">inspect</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'> 98</span> 						</span><span class="NAME">Coastline.walk</span><span class="PUNC">(</span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="NAME">Coastline.assembled_coastline</span><span class="PUNC">[</span><span class="NAME">index</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">n</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'> 99</span> 							</span><span class="NAME">$C.line_to</span><span class="PUNC">(</span><span class="NAME">n</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="NAME">n</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>100</span> 						</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>101</span> 					</span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'>102</span> 				</span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'>103</span> 
<span class='linenumber'>104</span> 				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">index</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>105</span> 					</span><span class="NAME">start_corner</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="WHIT">
<span class='linenumber'>106</span> 					</span><span class="NAME">start_angle</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="WHIT">
<span class='linenumber'>107</span> 				</span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'>108</span> 				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">index</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">Coastline.assembled_coastline.length</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>109</span> 					</span><span class="NAME">end_corner</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">3</span><span class="PUNC">]</span><span class="WHIT">
<span class='linenumber'>110</span> 					</span><span class="NAME">end_angle</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">coastline</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="WHIT">
<span class='linenumber'>111</span> 				</span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'>112</span> 			</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="KEYW">this</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>113</span> 
<span class='linenumber'>114</span> 			</span><span class="COMM">// $C.save()</span><span class="WHIT">
<span class='linenumber'>115</span> 			</span><span class="COMM">// $C.opacity(0.4)</span><span class="WHIT">
<span class='linenumber'>116</span> 			</span><span class="COMM">// $C.fill_style('yellow')</span><span class="WHIT">
<span class='linenumber'>117</span> 			</span><span class="COMM">// $C.rect(end_corner[0]-35,end_corner[1]-35,70,70)</span><span class="WHIT">
<span class='linenumber'>118</span> 			</span><span class="COMM">// $C.restore()</span><span class="WHIT">
<span class='linenumber'>119</span> 			</span><span class="COMM">// </span><span class="WHIT">
<span class='linenumber'>120</span> 			</span><span class="COMM">// $C.save()</span><span class="WHIT">
<span class='linenumber'>121</span> 			</span><span class="COMM">// $C.opacity(1)</span><span class="WHIT">
<span class='linenumber'>122</span> 			</span><span class="COMM">// $C.fill_style('purple')</span><span class="WHIT">
<span class='linenumber'>123</span> 			</span><span class="COMM">// $C.rect(start_corner[0]-20,start_corner[1]-20,40,40)</span><span class="WHIT">
<span class='linenumber'>124</span> 			</span><span class="COMM">// $C.restore()</span><span class="WHIT">
<span class='linenumber'>125</span> 		
<span class='linenumber'>126</span> 		
<span class='linenumber'>127</span> 			</span><span class="COMM">// if </span><span class="WHIT">
<span class='linenumber'>128</span> 			</span><span class="COMM">// walk back to the start point ONLY if the start angle is less than the end angle.</span><span class="WHIT">
<span class='linenumber'>129</span> 			</span><span class="COMM">// it's not enough to know they're both at corner 1; did it turn clockwise or not?</span><span class="WHIT">
<span class='linenumber'>130</span> 			</span><span class="COMM">// $l('angles: end:'+end_corner[2]+'/'+parseInt((end_angle*180)/Math.PI) +', start:'+start_corner[2]+'/'+ parseInt((start_angle*180)/Math.PI))</span><span class="WHIT">
<span class='linenumber'>131</span> 				</span><span class="COMM">// $C.save()</span><span class="WHIT">
<span class='linenumber'>132</span> 				</span><span class="COMM">// $C.opacity(1)</span><span class="WHIT">
<span class='linenumber'>133</span> 				</span><span class="COMM">// $C.fill_style('red')</span><span class="WHIT">
<span class='linenumber'>134</span> 				</span><span class="COMM">// $C.translate(Map.x,Map.y)</span><span class="WHIT">
<span class='linenumber'>135</span> 				</span><span class="COMM">// $C.rotate(end_angle)</span><span class="WHIT">
<span class='linenumber'>136</span> 				</span><span class="COMM">// $C.rect(0,-100,4,100)</span><span class="WHIT">
<span class='linenumber'>137</span> 				</span><span class="COMM">// $C.rotate(-end_angle)</span><span class="WHIT">
<span class='linenumber'>138</span> 				</span><span class="COMM">// $C.fill_style('green')</span><span class="WHIT">
<span class='linenumber'>139</span> 				</span><span class="COMM">// $C.rotate(start_angle)</span><span class="WHIT">
<span class='linenumber'>140</span> 				</span><span class="COMM">// $C.rect(0,-100,4,100)</span><span class="WHIT">
<span class='linenumber'>141</span> 				</span><span class="COMM">// $C.rotate(-start_angle)</span><span class="WHIT">
<span class='linenumber'>142</span> 				</span><span class="COMM">// $C.translate(-Map.x,-Map.y)</span><span class="WHIT">
<span class='linenumber'>143</span> 				</span><span class="COMM">// $C.restore()</span><span class="WHIT">
<span class='linenumber'>144</span> 			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">end_corner</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">start_corner</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">end_angle</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">start_angle</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>145</span> 				</span><span class="COMM">// $l('no-walk!!')</span><span class="WHIT">
<span class='linenumber'>146</span> 			</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">end_corner</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">start_corner</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">end_angle</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NAME">start_angle</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>147</span> 				</span><span class="NAME">corners.push</span><span class="PUNC">(</span><span class="NAME">end_corner</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="NAME">start_corner</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>148</span> 				</span><span class="NAME">$l</span><span class="PUNC">(</span><span class="STRN">'walking around!: '</span><span class="PUNC">+</span><span class="NAME">end_corner</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">+</span><span class="STRN">"/"</span><span class="PUNC">+</span><span class="NAME">start_corner</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">+</span><span class="STRN">':'</span><span class="PUNC">+</span><span class="NAME">Coastline.walk</span><span class="PUNC">(</span><span class="NAME">end_corner</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="NAME">start_corner</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">inspect</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>149</span> 				</span><span class="NAME">Coastline.walk</span><span class="PUNC">(</span><span class="NAME">end_corner</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="NAME">start_corner</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">n</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>150</span> 					</span><span class="NAME">$C.line_to</span><span class="PUNC">(</span><span class="NAME">n</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="NAME">n</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>151</span> 				</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>152</span> 			</span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'>153</span> 			</span><span class="NAME">$l</span><span class="PUNC">(</span><span class="STRN">'ending: '</span><span class="PUNC">+</span><span class="NAME">corners</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>154</span> 		
<span class='linenumber'>155</span> 			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">coastline_style</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Style.styles.relation</span><span class="WHIT">
<span class='linenumber'>156</span> 			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">coastline_style.lineWidth</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">$C.line_width</span><span class="PUNC">(</span><span class="NAME">coastline_style.lineWidth</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>157</span> 			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">coastline_style.strokeStyle</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">$C.stroke_style</span><span class="PUNC">(</span><span class="NAME">coastline_style.strokeStyle</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>158</span> 			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">coastline_style.opacity</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">$C.opacity</span><span class="PUNC">(</span><span class="NAME">coastline_style.opacity</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>159</span> 			</span><span class="NAME">$C.stroke</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>160</span> 			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">coastline_style.pattern</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>161</span> 				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">coastline_style.pattern.src</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>162</span> 					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">coastline_style.pattern</span><span class="WHIT">
<span class='linenumber'>163</span> 					</span><span class="NAME">coastline_style.pattern</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Image</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>164</span> 					</span><span class="NAME">coastline_style.pattern.src</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">value</span><span class="WHIT">
<span class='linenumber'>165</span> 				</span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'>166</span> 				</span><span class="NAME">$C.fill_pattern</span><span class="PUNC">(</span><span class="NAME">coastline_style.pattern</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">'repeat'</span><span class="PUNC">)</span><span class="WHIT">	
<span class='linenumber'>167</span> 			</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="NAME">$C.fill_style</span><span class="PUNC">(</span><span class="NAME">coastline_style.fillStyle</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>168</span> 			</span><span class="NAME">$C.fill</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>169</span> 		</span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'>170</span> 	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='linenumber'>171</span> 	</span><span class="NAME">refresh_coastlines</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>172</span> 		</span><span class="COMM">// flush coastline collected_ways relations and re-generate them with new coastlines:</span><span class="WHIT">
<span class='linenumber'>173</span> 		</span><span class="NAME">Coastline.coastlines.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">c</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="NAME">c.neighbors</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>174</span> 		</span><span class="NAME">Coastline.coastlines.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">coastline_a</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>175</span> 			</span><span class="NAME">Coastline.coastlines.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">coastline_b</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>176</span> 				</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">coastline_a.id</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">coastline_b.id</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>177</span> 					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">coastline_a.nodes.last</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">id</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">coastline_b.nodes.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">id</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>178</span> 						</span><span class="NAME">coastline_a.neighbors</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">coastline_b</span><span class="WHIT">
<span class='linenumber'>179</span> 						</span><span class="NAME">coastline_b.neighbors</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">coastline_a</span><span class="WHIT">
<span class='linenumber'>180</span> 					</span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'>181</span> 				</span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'>182</span> 			</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>183</span> 		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>184</span> 		
<span class='linenumber'>185</span> 		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">coastline_chains</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Coastline.coastlines.clone</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>186</span> 		</span><span class="NAME">Feature.relations</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Hash</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>187</span> 		</span><span class="KEYW">while</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">coastline_chains.length</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>188</span> 			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">data</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>189</span> 				</span><span class="NAME">members</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">coastline_chains.first</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">chain</span><span class="PUNC">(</span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="KEYW">true</span><span class="PUNC">,</span><span class="KEYW">true</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>190</span> 			</span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'>191</span> 			</span><span class="COMM">// remove chain members from coastline chain:</span><span class="WHIT">
<span class='linenumber'>192</span> 			</span><span class="NAME">data.members.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">member</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>193</span> 				</span><span class="NAME">coastline_chains.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">coastline</span><span class="PUNC">,</span><span class="NAME">index</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>194</span> 					</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">coastline.id</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">member.id</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">coastline_chains.splice</span><span class="PUNC">(</span><span class="NAME">index</span><span class="PUNC">,</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>195</span> 				</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>196</span> 			</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>197</span> 			</span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Relation</span><span class="PUNC">(</span><span class="NAME">data</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>198</span> 		</span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'>199</span> 		</span><span class="NAME">$l</span><span class="PUNC">(</span><span class="STRN">'refreshed coastlines'</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>200</span> 		</span><span class="NAME">Feature.relations.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">r</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>201</span> 			</span><span class="NAME">$l</span><span class="PUNC">(</span><span class="NAME">r.inspect</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>202</span> 		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>203</span> 	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='linenumber'>204</span> 	</span><span class="COMM">/**
<span class='linenumber'>205</span> 	 * Returns an array of points (corners) along the edge of the Viewport from the start param to the end param.
<span class='linenumber'>206</span> 	 * Params are integers where corner is 0,1,2,3 clockwise from top left. Returns as [[x,y],[x,y]...]
<span class='linenumber'>207</span> 	 * @param {Array} start The corner to begin the walk.
<span class='linenumber'>208</span> 	 * @param {Array} end The corner to walk to.
<span class='linenumber'>209</span> 	 */</span><span class="WHIT">
<span class='linenumber'>210</span> 	</span><span class="NAME">walk</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">start</span><span class="PUNC">,</span><span class="NAME">end</span><span class="PUNC">,</span><span class="NAME">clockwise</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>211</span> 		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">Object.isUndefined</span><span class="PUNC">(</span><span class="NAME">clockwise</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">clockwise</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="WHIT">
<span class='linenumber'>212</span> 		</span><span class="NAME">$l</span><span class="PUNC">(</span><span class="NAME">start</span><span class="PUNC">+</span><span class="STRN">'/'</span><span class="PUNC">+</span><span class="NAME">end</span><span class="PUNC">+</span><span class="STRN">',clockwise '</span><span class="PUNC">+</span><span class="NAME">clockwise</span><span class="PUNC">+</span><span class="STRN">': '</span><span class="PUNC">+</span><span class="NAME">this.walk_n</span><span class="PUNC">(</span><span class="NAME">start</span><span class="PUNC">,</span><span class="NAME">end</span><span class="PUNC">,</span><span class="NAME">clockwise</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>213</span> 		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">nodes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="WHIT">
<span class='linenumber'>214</span> 		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">bbox</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Viewport.full_bbox</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>215</span> 		</span><span class="COMM">// if (clockwise == false) bbox = bbox.reverse()</span><span class="WHIT">
<span class='linenumber'>216</span> 		</span><span class="COMM">// this doesn't make sense:</span><span class="WHIT">
<span class='linenumber'>217</span> 		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">clockwise</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>218</span> 			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">start</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NAME">end</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">slice_end</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">bbox.length</span><span class="WHIT">
<span class='linenumber'>219</span> 			</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">slice_end</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">end</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="WHIT">
<span class='linenumber'>220</span> 			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cycle</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">bbox.slice</span><span class="PUNC">(</span><span class="NAME">start</span><span class="PUNC">,</span><span class="NAME">slice_end</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="COMM">// path clockwise to walk around the viewport</span><span class="WHIT">
<span class='linenumber'>221</span> 			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">start</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NAME">end</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">start</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">end</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">start</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">cycle</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">cycle.concat</span><span class="PUNC">(</span><span class="NAME">bbox.slice</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="NAME">end</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="COMM">//loop around from 3 back to 0</span><span class="WHIT">
<span class='linenumber'>222</span> 		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>223</span> 			</span><span class="COMM">//this is all fucked up:</span><span class="WHIT">
<span class='linenumber'>224</span> 			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">start</span><span class="WHIT"> </span><span class="PUNC">&lt;=</span><span class="WHIT"> </span><span class="NAME">end</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">slice_end</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">bbox.length</span><span class="WHIT">
<span class='linenumber'>225</span> 			</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">slice_end</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">start</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="WHIT">
<span class='linenumber'>226</span> 			</span><span class="COMM">// if (end > 0) end -= 1</span><span class="WHIT">
<span class='linenumber'>227</span> 			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cycle</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">bbox.slice</span><span class="PUNC">(</span><span class="NAME">end</span><span class="PUNC">,</span><span class="NAME">slice_end</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="COMM">// path clockwise to walk around the viewport</span><span class="WHIT">
<span class='linenumber'>228</span> 			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">start</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">end</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">start</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">end</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">end</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">cycle</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">cycle.concat</span><span class="PUNC">(</span><span class="NAME">bbox.slice</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="NAME">start</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="COMM">//loop around from 3 back to 0</span><span class="WHIT">
<span class='linenumber'>229</span> 			</span><span class="NAME">cycle</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">cycle.reverse</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>230</span> 		</span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'>231</span> 		</span><span class="NAME">cycle.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">coord</span><span class="PUNC">,</span><span class="NAME">index</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>232</span> 			</span><span class="NAME">nodes.push</span><span class="PUNC">(</span><span class="PUNC">[</span><span class="NAME">coord</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="NAME">coord</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>233</span> 			</span><span class="COMM">// if (clockwise) nodes.push([coord[0],coord[1]])</span><span class="WHIT">
<span class='linenumber'>234</span> 			</span><span class="COMM">// else nodes.unshift([coord[0],coord[1]])</span><span class="WHIT">
<span class='linenumber'>235</span> 
<span class='linenumber'>236</span> 			</span><span class="COMM">// $C.line_to(coord[0],coord[1])</span><span class="WHIT">
<span class='linenumber'>237</span> 
<span class='linenumber'>238</span> 			</span><span class="COMM">// $C.save()</span><span class="WHIT">
<span class='linenumber'>239</span> 			</span><span class="COMM">// $C.opacity(1)</span><span class="WHIT">
<span class='linenumber'>240</span> 			</span><span class="COMM">// $C.fill_style('black')</span><span class="WHIT">
<span class='linenumber'>241</span> 			</span><span class="COMM">// $C.rect(coord[0]-15,coord[1]-15,30,30)</span><span class="WHIT">
<span class='linenumber'>242</span> 			</span><span class="COMM">// $C.draw_text("Helvetica",40,'white',coord[0]-20,coord[1]-20,index)</span><span class="WHIT">
<span class='linenumber'>243</span> 			</span><span class="COMM">// $C.restore()</span><span class="WHIT">
<span class='linenumber'>244</span> 		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>245</span> 		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">nodes</span><span class="WHIT">
<span class='linenumber'>246</span> 	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='linenumber'>247</span> 	</span><span class="NAME">walk_n</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">start</span><span class="PUNC">,</span><span class="NAME">end</span><span class="PUNC">,</span><span class="NAME">clockwise</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>248</span> 		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">Object.isUndefined</span><span class="PUNC">(</span><span class="NAME">clockwise</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">clockwise</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="WHIT">
<span class='linenumber'>249</span> 		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">nodes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="WHIT">
<span class='linenumber'>250</span> 		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">bbox</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="NUMB">2</span><span class="PUNC">,</span><span class="NUMB">3</span><span class="PUNC">]</span><span class="COMM">//Viewport.full_bbox()</span><span class="WHIT">
<span class='linenumber'>251</span> 		</span><span class="COMM">// if (clockwise == false) bbox = bbox.reverse()</span><span class="WHIT">
<span class='linenumber'>252</span> 		</span><span class="COMM">// this doesn't make sense:</span><span class="WHIT">
<span class='linenumber'>253</span> 		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">clockwise</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>254</span> 			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">start</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="NAME">end</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">slice_end</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">bbox.length</span><span class="WHIT">
<span class='linenumber'>255</span> 			</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">slice_end</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">end</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="WHIT">
<span class='linenumber'>256</span> 			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cycle</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">bbox.slice</span><span class="PUNC">(</span><span class="NAME">start</span><span class="PUNC">,</span><span class="NAME">slice_end</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="COMM">// path clockwise to walk around the viewport</span><span class="WHIT">
<span class='linenumber'>257</span> 			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">start</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NAME">end</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">start</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">end</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">start</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">cycle</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">cycle.concat</span><span class="PUNC">(</span><span class="NAME">bbox.slice</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="NAME">end</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="COMM">//loop around from 3 back to 0</span><span class="WHIT">
<span class='linenumber'>258</span> 		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>259</span> 			</span><span class="COMM">//this is all fucked up:</span><span class="WHIT">
<span class='linenumber'>260</span> 			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">start</span><span class="WHIT"> </span><span class="PUNC">&lt;=</span><span class="WHIT"> </span><span class="NAME">end</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">slice_end</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">bbox.length</span><span class="WHIT">
<span class='linenumber'>261</span> 			</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">slice_end</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">start</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="WHIT">
<span class='linenumber'>262</span> 			</span><span class="COMM">// if (end > 0) end -= 1</span><span class="WHIT">
<span class='linenumber'>263</span> 			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">cycle</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">bbox.slice</span><span class="PUNC">(</span><span class="NAME">end</span><span class="PUNC">,</span><span class="NAME">slice_end</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="COMM">// path clockwise to walk around the viewport</span><span class="WHIT">
<span class='linenumber'>264</span> 			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">start</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">end</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">start</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">end</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">end</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="NAME">cycle</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">cycle.concat</span><span class="PUNC">(</span><span class="NAME">bbox.slice</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="NAME">start</span><span class="PUNC">+</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="COMM">//loop around from 3 back to 0</span><span class="WHIT">
<span class='linenumber'>265</span> 			</span><span class="NAME">cycle</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">cycle.reverse</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>266</span> 		</span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'>267</span> 		</span><span class="NAME">cycle.each</span><span class="PUNC">(</span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">coord</span><span class="PUNC">,</span><span class="NAME">index</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='linenumber'>268</span> 			</span><span class="COMM">// nodes.push([coord[0],coord[1]])</span><span class="WHIT">
<span class='linenumber'>269</span> 			</span><span class="NAME">nodes.push</span><span class="PUNC">(</span><span class="NAME">coord</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>270</span> 			</span><span class="COMM">// if (clockwise) nodes.push([coord[0],coord[1]])</span><span class="WHIT">
<span class='linenumber'>271</span> 			</span><span class="COMM">// else nodes.unshift([coord[0],coord[1]])</span><span class="WHIT">
<span class='linenumber'>272</span> 
<span class='linenumber'>273</span> 			</span><span class="COMM">// $C.line_to(coord[0],coord[1])</span><span class="WHIT">
<span class='linenumber'>274</span> 
<span class='linenumber'>275</span> 			</span><span class="COMM">// $C.save()</span><span class="WHIT">
<span class='linenumber'>276</span> 			</span><span class="COMM">// $C.opacity(1)</span><span class="WHIT">
<span class='linenumber'>277</span> 			</span><span class="COMM">// $C.fill_style('black')</span><span class="WHIT">
<span class='linenumber'>278</span> 			</span><span class="COMM">// $C.rect(coord[0]-15,coord[1]-15,30,30)</span><span class="WHIT">
<span class='linenumber'>279</span> 			</span><span class="COMM">// $C.draw_text("Helvetica",40,'white',coord[0]-20,coord[1]-20,index)</span><span class="WHIT">
<span class='linenumber'>280</span> 			</span><span class="COMM">// $C.restore()</span><span class="WHIT">
<span class='linenumber'>281</span> 		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='linenumber'>282</span> 		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">nodes</span><span class="WHIT">
<span class='linenumber'>283</span> 	</span><span class="PUNC">}</span><span class="PUNC">,</span><span class="WHIT">
<span class='linenumber'>284</span> 	</span><span class="COMM">/**
<span class='linenumber'>285</span> 	 * Sorts coastlines a and b from assembled_coastlines by angle of entry
<span class='linenumber'>286</span> 	 */</span><span class="WHIT">
<span class='linenumber'>287</span> 	</span><span class="NAME">sort_coastlines_by_angle</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">a</span><span class="PUNC">,</span><span class="NAME">b</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"> </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">a</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">b</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'>288</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='linenumber'>289</span> 
<span class='linenumber'>290</span> </span><span class="NAME">document.observe</span><span class="PUNC">(</span><span class="STRN">'cartagen:init'</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">Coastline.initialize.bindAsEventListener</span><span class="PUNC">(</span><span class="NAME">Coastline</span><span class="PUNC">)</span><span class="PUNC">)</span></pre></body></html>